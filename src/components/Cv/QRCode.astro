---
interface Props {
  url: string;
  label?: string;
  print?: boolean;
}

const { url, label, print } = Astro.props;

import QrCode from "qrcode";

const qrDataUrl = await QrCode.toDataURL(url, {
  width: 400,
  margin: 2,
  color: {
    dark: "#000000",
    light: "#ffffff",
  },
});

const modalId = "qr-modal-" + Math.random().toString(36).substr(2, 9);
---
{
  !print && (
    <button
      type="button"
      data-qr-modal-trigger={modalId}
      class="w-8 h-8 m-0 flex justify-center items-center font-mono text-lg font-medium text-gray-900 rounded hover:ring-2 ring-transparent hover:ring-gray-300 dark:text-white print:hidden"
      aria-label="Ver código QR"
      title="Ver código QR"
    >
      <svg
        xmlns="http://www.w3.org/2000/svg"
        width="32"
        height="32"
        viewBox="0 0 24 24"
        class="w-6 h-6"
      >
        <path
          class="fill-gray-800 dark:fill-white"
          d="M3 11h8V3H3zm2-6h4v4H5zM3 21h8v-8H3zm2-6h4v4H5zM13 3v8h8V3zm6 6h-4V5h4zM13 13h2v2h-2zM15 15h2v2h-2zM13 17h2v2h-2zM17 13h2v2h-2zM19 15h2v2h-2zM17 17h2v2h-2zM15 19h2v2h-2zM19 19h2v2h-2z"
        ></path>
      </svg>
    </button>

    <div
      id={modalId}
      data-qr-modal
      class="fixed inset-0 z-[100] hidden bg-black/90 items-center justify-center p-4"
      role="dialog"
      aria-modal="true"
      aria-label="Código QR"
    >
      <button
        type="button"
        data-qr-modal-close={modalId}
        class="absolute top-4 right-4 w-12 h-12 flex items-center justify-center text-white hover:text-gray-300 transition-colors"
        aria-label="Cerrar modal"
      >
        <svg
          xmlns="http://www.w3.org/2000/svg"
          width="32"
          height="32"
          viewBox="0 0 24 24"
        >
          <path
            fill="currentColor"
            d="M19 6.41L17.59 5L12 10.59L6.41 5L5 6.41L10.59 12L5 17.59L6.41 19L12 13.41L17.59 19L19 17.59L13.41 12z"
          ></path>
        </svg>
      </button>

      <div class="flex flex-col items-center gap-6">
        <div class="bg-white p-4 rounded-lg shadow-2xl">
          <img src={qrDataUrl} alt="Código QR" class="w-64 h-64 md:w-80 md:h-80" />
        </div>
        <p class="text-white text-sm font-mono">{url}</p>
      </div>
    </div>
  )
}
{
  print && (
    <div class="hidden print:flex absolute w-28 h-28 justify-center items-center print:bottom-0 print:left-0 print:z-50 translate-x-3 -translate-y-5">
        <img src={qrDataUrl} alt="Código QR" class="w-16 h-16" />
    </div>
  )
}

<script define:vars={{ modalId }}>
  const modal = document.getElementById(modalId);
  const trigger = document.querySelector(
    `[data-qr-modal-trigger="${modalId}"]`,
  );
  const closeBtn = document.querySelector(`[data-qr-modal-close="${modalId}"]`);

  function openModal() {
    modal.classList.remove("hidden");
    document.body.style.overflow = "hidden";
  }

  function closeModal() {
    modal.classList.add("hidden");
    document.body.style.overflow = "";
  }

  trigger?.addEventListener("click", openModal);
  closeBtn?.addEventListener("click", closeModal);

  // Cerrar al hacer clic fuera del QR
  modal?.addEventListener("click", (e) => {
    if (e.target === modal) {
      closeModal();
    }
  });

  // Cerrar con tecla Escape
  document.addEventListener("keydown", (e) => {
    if (e.key === "Escape" && !modal.classList.contains("hidden")) {
      closeModal();
    }
  });
</script>
